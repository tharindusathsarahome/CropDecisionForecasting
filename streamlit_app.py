import streamlit as st
from google import generativeai as genai
from PIL import Image
import io

# --- 1. ‡∂¥‡∑í‡∂ß‡∑î ‡∑É‡∑ê‡∂ö‡∑É‡∑î‡∂∏ ‡∑É‡∑Ñ API ‡∂∫‡∂≠‡∑î‡∂ª ---
st.set_page_config(
    page_title="Plant Disease Analyzer",
    page_icon="üå±",
    layout="centered"
)

# API ‡∂∫‡∂≠‡∑î‡∂ª ‡∂Ω‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏
try:
    api_key = st.secrets['GEMINI_API_KEY']
    genai.configure(api_key=api_key)
except Exception:
    st.error("GEMINI_API_KEY ‡∑É‡∑ú‡∂∫‡∑è‡∂ú‡∂≠ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂ë‡∂∫ ‡∂î‡∂∂‡∂ú‡∑ö Streamlit ‡∂ª‡∑Ñ‡∑É‡∑ä ‡∑Ä‡∑ô‡∂≠ ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.")
    st.stop()

# --- 2. ‡∂±‡∑Ä, ‡∂í‡∂ö‡∑è‡∂∂‡∂Ø‡∑ä‡∂∞ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í ‡∂ã‡∂¥‡∂Ø‡∑ô‡∑É (‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∑Ö) ---
SYSTEM_INSTRUCTION = """
‡∂î‡∂∂ ‡∑Å‡∑è‡∂ö ‡∂ª‡∑ù‡∂ú ‡∂¥‡∑í‡∑Ö‡∑í‡∂∂‡∂≥ ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç‡∂•, ‡∂ã‡∂¥‡∂ö‡∑è‡∂ª‡∑Å‡∑ì‡∂Ω‡∑ì ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∑É‡∑Ñ‡∑è‡∂∫‡∂ö‡∂∫‡∑ô‡∂ö‡∑í. ‡∂î‡∂∂‡∂ú‡∑ö ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø‡∂∫ ‡∂Ö‡∂Ø‡∑í‡∂∫‡∂ª ‡∂≠‡∑î‡∂±‡∂ö‡∑í‡∂±‡∑ä ‡∑É‡∂∏‡∂±‡∑ä‡∑Ä‡∑í‡∂≠ ‡∑Ä‡∑ö.

‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂ª‡∑ì‡∂≠‡∑í‡∂∫: ‡∂î‡∂∂‡∂ú‡∑ö ‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∂Ö‡∂±‡∑í‡∑Ä‡∑è‡∂ª‡∑ä‡∂∫‡∂∫‡∑ô‡∂±‡∑ä‡∂∏ ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä‡∑ô‡∂±‡∑ä ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫. ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è ‡∂â‡∂Ç‡∂ú‡∑ä‚Äç‡∂ª‡∑ì‡∑É‡∑í‡∂∫‡∑ô‡∂±‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂± ‡∂á‡∑É‡∑î‡∑Ä‡∂Ø, ‡∂î‡∂∂‡∂ú‡∑ö ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∑ô‡∂±‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±.

‡∂Ö‡∂Ø‡∑í‡∂∫‡∂ª 1: ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏ ‡∑É‡∑Ñ ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
- ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑î‡∂±‡∑ä ‡∑Ä‡∑í‡∂ß, ‡∂î‡∂∂‡∑ö ‡∂¥‡∑Ö‡∂∏‡∑î ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫ ‡∑Ä‡∂±‡∑ä‡∂±‡∑ö ‡∂ë‡∑Ñ‡∑í ‡∂á‡∂≠‡∑í ‡∑Å‡∑è‡∂ö‡∂∫ ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∑ô‡∂±‡∑ä ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂∫‡∑í.
- ‡∂â‡∂±‡∑ä‡∂¥‡∑É‡∑î, ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è‡∂ú‡∑ô‡∂±‡∑ä "‡∂∏‡∑ô‡∂∫ '‡∑Å‡∑è‡∂ö‡∂∫‡∑ö ‡∂±‡∂∏' ‡∂Ø?" ‡∂Ω‡∑ô‡∑É ‡∂Ö‡∑É‡∑è ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª‡∂ú‡∂±‡∑ä‡∂±.

‡∂Ö‡∂Ø‡∑í‡∂∫‡∂ª 2: ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂± ‡∂á‡∑É‡∑ì‡∂∏ ‡∑É‡∑Ñ ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫
- ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è "‡∂î‡∑Ä‡∑ä" ‡∑Ñ‡∑ù ‡∂í ‡∑Ñ‡∑è ‡∑É‡∂∏‡∑è‡∂± ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∂ö‡∑ä ‡∂Ø‡∑î‡∂±‡∑ä ‡∑Ä‡∑í‡∂ß, ‡∂ª‡∑ù‡∂ú‡∂∫ ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∑Ä ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∂Ö‡∂Ø‡∑è‡∑Ö ‡∑É‡∂ª‡∂Ω ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂± 2-3‡∂ö‡∑ä (‡∂ã‡∂Ø‡∑è: ‡∂ö‡∑è‡∂Ω‡∂ú‡∑î‡∂´‡∂∫, ‡∂¢‡∂Ω‡∂∫, ‡∑Ñ‡∑í‡∂ª‡∑î ‡∂ë‡∑Ö‡∑í‡∂∫ ‡∂ú‡∑ê‡∂±) ‡∂Ö‡∑É‡∂±‡∑ä‡∂±.
- ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è ‡∂ë‡∂∏ ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±‡∑Ä‡∂Ω‡∂ß ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∂Ø‡∑î‡∂±‡∑ä ‡∂¥‡∑É‡∑î, ‡∂ë‡∂∏ ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∑É‡∑Ñ ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫ ‡∂¥‡∂Ø‡∂±‡∂∏‡∑ä ‡∂ö‡∂ª‡∂ú‡∑ô‡∂± ‡∑É‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä‡∂ö‡∑ä ‡∑É‡∂¥‡∂∫‡∂±‡∑ä‡∂±. ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä‡∑ö: 1. ‡∂ª‡∑ù‡∂ú ‡∑Ä‡∑í‡∂±‡∑í‡∑Å‡∑ä‡∂†‡∂∫, 2. ‡∑Ñ‡∑ö‡∂≠‡∑î, 3. ‡∑Ä‡∑í‡∑É‡∂≥‡∑î‡∂∏‡∑ä (‡∂ö‡∑è‡∂∂‡∂±‡∑í‡∂ö, ‡∂ª‡∑É‡∑è‡∂∫‡∂±‡∑í‡∂ö, ‡∑Ä‡∑ê‡∑Ö‡∑ê‡∂ö‡∑ä‡∑Ä‡∑ì‡∂∏) ‡∂Ö‡∂©‡∂Ç‡∂ú‡∑î ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫.

‡∂Ö‡∂Ø‡∑í‡∂∫‡∂ª 3: ‡∂Ö‡∂õ‡∂´‡∑ä‡∂© ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø‡∂∫
- ‡∑É‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ì‡∂∏‡∑ô‡∂±‡∑ä ‡∂¥‡∑É‡∑î‡∑Ä, ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø‡∂∫ ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä ‡∂±‡∑ú‡∂ö‡∂ª‡∂±‡∑ä‡∂±.
- ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è ‡∂Ö‡∑É‡∂± ‡∂ï‡∂±‡∑ë‡∂∏ ‡∑Ä‡∑ê‡∂©‡∑í‡∂Ø‡∑î‡∂ª ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±‡∂∫‡∂ö‡∂ß (follow-up questions), ‡∂î‡∑Ä‡∑î‡∂±‡∑ä ‡∂â‡∂Ç‡∂ú‡∑ä‚Äç‡∂ª‡∑ì‡∑É‡∑í‡∂∫‡∑ô‡∂±‡∑ä ‡∂á‡∑É‡∑î‡∑Ä‡∂Ø, ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∑ô‡∂±‡∑ä ‡∂ã‡∂¥‡∂ö‡∑è‡∂ª‡∑Å‡∑ì‡∂Ω‡∑ì‡∑Ä ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±.
- ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è "‡∂±‡∑ê‡∂≠" ‡∂ö‡∑í‡∂∫‡∑è ‡∑Å‡∑è‡∂ö‡∂∫ ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂∂‡∑Ä ‡∂¥‡∑ê‡∑Ä‡∑É‡∑î‡∑Ä‡∑Ñ‡∑ú‡∂≠‡∑ä, ‡∑É‡∂∏‡∑è‡∑Ä ‡∂Ö‡∂∫‡∑ê‡∂Ø ‡∑Ä‡∑ô‡∂±‡∂≠‡∑ä ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑è ‡∑É‡∑í‡∂ß‡∑í‡∂±‡∑ä‡∂±.
""
"""

# --- 3. ‡∂Ü‡∂ö‡∑ò‡∂≠‡∑í‡∂∫ ‡∑É‡∑Ñ Session State ‡∑É‡∑ê‡∂ö‡∑É‡∑ì‡∂∏ ---

# session state ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
if "chat" not in st.session_state:
    # ‡∂Ö‡∂¥‡∑í ‡∂Ø‡∑ê‡∂±‡∑ä ‡∂Ü‡∂ö‡∑ò‡∂≠‡∑í‡∂∫ session state ‡∂ë‡∂ö‡∑ö‡∂∏ ‡∂ú‡∂∂‡∂©‡∑è ‡∂ö‡∂ª‡∂±‡∑Ä‡∑è.
    model = genai.GenerativeModel(
        model_name="gemini-1.5-pro-latest",
        system_instruction=SYSTEM_INSTRUCTION
    )
    st.session_state.chat = model.start_chat(history=[])

if "uploader_key" not in st.session_state:
    st.session_state.uploader_key = 0

def reset_chat():
    st.session_state.uploader_key += 1
    # session state ‡∑Ñ‡∑í ‡∂á‡∂≠‡∑í ‡∑É‡∑í‡∂∫‡∂Ω‡∑ä‡∂Ω ‡∂∏‡∂ö‡∑è ‡∂Ø‡∂∏‡∑è ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    st.session_state.clear()
    st.rerun()

# --- 4. UI ‡∂ö‡∑ú‡∂ß‡∑É ---
st.title("üå± Plant Disease Analyzer")
st.write("‡∂î‡∂∂‡∑ö ‡∑Å‡∑è‡∂ö‡∂∫‡∑ö ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂¥‡∑ê‡∂≠‡∑í ‡∂≠‡∑ì‡∂ª‡∑î‡∑Ä‡∑ô‡∂±‡∑ä ‡∂ã‡∂©‡∑î‡∂ú‡∂≠ ‡∂ö‡∂ª ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø‡∂∫ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.")

with st.sidebar:
    st.header("‡∂î‡∂∂‡∑ö ‡∑Å‡∑è‡∂ö‡∂∫")
    uploaded_file = st.file_uploader(
        "‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂ã‡∂©‡∑î‡∂ú‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±",
        type=["jpg", "jpeg", "png"],
        key=f"uploader_{st.session_state.uploader_key}"
    )
    if st.button("‡∂±‡∑Ä ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø‡∂∫‡∂ö‡∑ä"):
        reset_chat()

# --- 5. ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í‡∂∫ (‡∂Ø‡∑ê‡∂±‡∑ä ‡∂â‡∂≠‡∑è ‡∑É‡∂ª‡∂Ω‡∂∫‡∑í) ---

# ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø ‡∂â‡∂≠‡∑í‡∑Ñ‡∑è‡∑É‡∂∫ ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏
for message in st.session_state.chat.history:
    # API ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± 'model' role ‡∂ë‡∂ö 'assistant' ‡∂Ω‡∑ô‡∑É ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    role = "assistant" if message.role == "model" else message.role
    with st.chat_message(role):
        st.markdown(message.parts[0].text)

# ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö ‡∂Ü‡∂Ø‡∑è‡∂±‡∂∫ ‡∑Ñ‡∑ê‡∑É‡∑í‡∂ª‡∑Ä‡∑ì‡∂∏
prompt_content = None
# ‡∂¥‡∑Ö‡∂∏‡∑î ‡∑Ä‡∂ª‡∂ß ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂ã‡∂©‡∑î‡∂ú‡∂≠ ‡∂ö‡∑Ö ‡∑Ä‡∑í‡∂ß, ‡∂ë‡∂∫ ‡∂¥‡∑Ö‡∂∏‡∑î prompt ‡∂ë‡∂ö ‡∂Ω‡∑ô‡∑É ‡∑É‡∂Ω‡∂ö‡∂±‡∑Ä‡∑è
if uploaded_file and not st.session_state.chat.history:
    prompt_content = [Image.open(uploaded_file)]
    st.sidebar.image(uploaded_file, caption="‡∂î‡∂∂‡∑ö ‡∑Å‡∑è‡∂ö‡∂∫")

# ‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ chat ‡∂Ü‡∂Ø‡∑è‡∂±‡∂∫
elif prompt := st.chat_input("‡∂î‡∂∂‡∑ö ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª ‡∂∏‡∑ô‡∑Ñ‡∑í ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±..."):
    prompt_content = [prompt]

# AI ‡∑Ä‡∑ô‡∂≠ ‡∂∫‡∑ê‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î ‡∂Ø‡∑ô‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑ä‡∂±‡∂∏‡∑ä ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑Ä‡∑ì‡∂∏
if prompt_content:
    with st.chat_message("user"):
        # ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂±‡∂∏‡∑ä, ‡∂ë‡∂∫ ‡∂±‡∑ú‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂∫‡∑í; text ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂±‡∂∏‡∑ä, ‡∂ë‡∂∫ ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂∫‡∑í
        if isinstance(prompt_content[0], str):
            st.markdown(prompt_content[0])

    # AI ‡∑Ä‡∑ô‡∂≠ ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏ ‡∂∫‡∑Ä‡∑è, ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª stream ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    with st.spinner("‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª ‡∑É‡∂ö‡∑É‡∂∏‡∑í‡∂±‡∑ä..."):
        with st.chat_message("assistant"):
            try:
                response = st.session_state.chat.send_message(prompt_content, stream=True)
                st.write_stream(response)
            except Exception as e:
                st.error(f"‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑í‡∑Ä‡∑í‡∂∫: {e}")

st.divider()
st.caption("‚ö†Ô∏è ‡∂∏‡∑ô‡∂∏ AI ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∑Ä‡∑ò‡∂≠‡∑ä‡∂≠‡∑ì‡∂∫ ‡∂ö‡∑ò‡∑Ç‡∑í‡∂ö‡∑è‡∂ª‡∑ä‡∂∏‡∑í‡∂ö ‡∂ã‡∂¥‡∂Ø‡∑ô‡∑É‡∑ä ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ü‡∂Ø‡∑ö‡∑Å‡∂ö‡∂∫‡∂ö‡∑ä ‡∑Ä‡∑ö.")