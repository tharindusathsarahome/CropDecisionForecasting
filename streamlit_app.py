import streamlit as st
from google import generativeai as genai
from PIL import Image
import io

# --- Streamlit ‡∂¥‡∑í‡∂ß‡∑î ‡∑É‡∑ê‡∂ö‡∑É‡∑î‡∂∏ ---
st.set_page_config(
    page_title="‡∑Å‡∑è‡∂ö ‡∑É‡∑û‡∂õ‡∑ä‚Äç‡∂∫ ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂ö‡∂∫",
    page_icon="üå±",
    layout="centered"
)

# --- API ‡∂∫‡∂≠‡∑î‡∂ª ‡∑É‡∑ê‡∂ö‡∑É‡∑ì‡∂∏ ---
try:
    api_key = st.secrets['GEMINI_API_KEY']
    genai.configure(api_key=api_key)
except (KeyError, Exception):
    st.error("GEMINI_API_KEY ‡∑É‡∑ú‡∂∫‡∑è‡∂ú‡∂≠ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂ë‡∂∫ ‡∂î‡∂∂‡∂ú‡∑ö Streamlit ‡∂ª‡∑Ñ‡∑É‡∑ä ‡∑Ä‡∑ô‡∂≠ ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.")
    st.stop()

# --- AI ‡∂Ü‡∂ö‡∑ò‡∂≠‡∑í‡∂∫ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í ‡∂ã‡∂¥‡∂Ø‡∑ô‡∑É‡∑ä (‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∑ô‡∂±‡∑ä) ---
SYSTEM_INSTRUCTION = """
‡∂î‡∂∂ ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∑É‡∑ê‡∂¥‡∂∫‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑ä‡∂≠‡∑ö ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä‡∑ô‡∂±‡∑ä ‡∂¥‡∂∏‡∂´‡∑í.

‡∂î‡∂∂ ‡∂ã‡∂Ø‡∑ä‡∂∑‡∑í‡∂Ø ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∑Ä ‡∑É‡∑Ñ ‡∑Å‡∑è‡∂ö ‡∂ª‡∑ù‡∂ú ‡∂¥‡∑í‡∑Ö‡∑í‡∂∂‡∂≥ ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç‡∂•‡∂∫‡∑ô‡∂ö‡∑í. ‡∂î‡∂∂‡∂ú‡∑ö ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫ ‡∑Ä‡∂±‡∑ä‡∂±‡∑ö ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è ‡∑Ä‡∑í‡∑É‡∑í‡∂±‡∑ä ‡∂ã‡∂©‡∑î‡∂ú‡∂≠ ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø ‡∑Å‡∑è‡∂ö ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥ ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∂ö‡∂ª ‡∂î‡∑Ä‡∑î‡∂±‡∑ä‡∂ú‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±‡∑Ä‡∂Ω‡∂ß ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä‡∑ô‡∂±‡∑ä ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∂Ø‡∑ì‡∂∏‡∂∫‡∑í.

**‡∑Ä‡∑ê‡∂Ø‡∂ú‡∂≠‡∑ä: ‡∂ª‡∑ñ‡∂¥‡∂∫‡∑ö ‡∂ú‡∑î‡∂´‡∑è‡∂≠‡∑ä‡∂∏‡∂ö‡∂∑‡∑è‡∑Ä‡∂∫ ‡∂¥‡∑Ö‡∂∏‡∑î‡∑Ä ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±:**
*   ‡∑Ä‡∑ô‡∂±‡∂≠‡∑ä ‡∂ï‡∂±‡∑ë‡∂∏ ‡∂Ø‡∑ô‡∂∫‡∂ö‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂¥‡∑ô‡∂ª, ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∑ö ‡∂ú‡∑î‡∂´‡∑è‡∂≠‡∑ä‡∂∏‡∂ö‡∂∑‡∑è‡∑Ä‡∂∫ ‡∂≠‡∂ö‡∑ä‡∑É‡∑ö‡∂ª‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.
*   ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫ **‡∂Ö‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í ‡∂±‡∂∏‡∑ä, ‡∂∂‡∑ú‡∂≥ ‡∑Ä‡∑ì ‡∂á‡∂≠‡∑ä‡∂±‡∂∏‡∑ä, ‡∂â‡∂≠‡∑è ‡∂Ö‡∂≥‡∑î‡∂ª‡∑î ‡∂±‡∂∏‡∑ä, ‡∂∂‡∑ú‡∑Ñ‡∑ù ‡∂Ø‡∑î‡∂ª‡∑í‡∂±‡∑ä ‡∂á‡∂≠‡∑ä‡∂±‡∂∏‡∑ä, ‡∑Ñ‡∑ù ‡∂ë‡∑Ñ‡∑í ‡∑Å‡∑è‡∂ö‡∂∫‡∂ö‡∑ä ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í‡∑Ä ‡∂±‡∑ú‡∂¥‡∑ô‡∂±‡∑ö ‡∂±‡∂∏‡∑ä**, ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫‡∂ö‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ **‡∂±‡∑ú‡∂ö‡∂ª‡∂±‡∑ä‡∂±**.
*   ‡∂í ‡∑Ä‡∑ô‡∂±‡∑î‡∑Ä‡∂ß, ‡∂ú‡∑ê‡∂ß‡∂Ω‡∑î‡∑Ä ‡∂ö‡∑è‡∂ª‡∑î‡∂´‡∑í‡∂ö‡∑Ä ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∑ô‡∂±‡∑ä ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í ‡∂ö‡∂ª, ‡∑Ä‡∂©‡∑è‡∂≠‡∑ä ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í, ‡∂±‡∑í‡∑Å‡∑ä‡∂†‡∑í‡∂≠ ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂ã‡∂©‡∑î‡∂ú‡∂≠ ‡∂ö‡∂ª‡∂± ‡∂Ω‡∑ô‡∑É ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è‡∂ú‡∑ô‡∂±‡∑ä ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑è ‡∑É‡∑í‡∂ß‡∑í‡∂±‡∑ä‡∂±. ‡∂ã‡∂Ø‡∑è‡∑Ñ‡∂ª‡∂´‡∂∫‡∂ö‡∑ä ‡∂Ω‡∑ô‡∑É, "‡∂∏‡∑ô‡∂∏ ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫ ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í ‡∂±‡∑ê‡∂≠. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Å‡∑è‡∂ö‡∂∫‡∑ö ‡∂∂‡∂Ω‡∂¥‡∑ë‡∂∏‡∂ß ‡∂Ω‡∂ö‡∑ä ‡∑Ä‡∑ñ ‡∂ö‡∑ú‡∂ß‡∑É‡∂ß ‡∂±‡∑è‡∂∑‡∑í‡∂ú‡∂≠ ‡∑Ä‡∑ñ (focused) ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±." ‡∑Ä‡∑ê‡∂±‡∑í ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∂ö‡∑ä ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±.
*   ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫ ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫‡∂ß ‡∑É‡∑î‡∂Ø‡∑î‡∑É‡∑î ‡∂±‡∂∏‡∑ä ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä, ‡∂¥‡∑Ñ‡∂≠ ‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª ‡∂Ö‡∂±‡∑î‡∂ú‡∂∏‡∂±‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.

**‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´ ‡∂∏‡∑è‡∂ª‡∑ä‡∂ú‡∑ù‡∂¥‡∂Ø‡∑ö‡∑Å‡∂∫:**
1.  **‡∂¥‡∑ô‡∂±‡∑ô‡∂± ‡∑Å‡∑è‡∂ö ‡∂ö‡∑ú‡∂ß‡∑É‡∑ä ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∂±‡∑ä‡∂±**: ‡∂ö‡∑ú‡∑Ö, ‡∂∏‡∂Ω‡∑ä, ‡∂ö‡∂≥‡∂±‡∑ä, ‡∂¥‡∑É ‡∂Ü‡∂Ø‡∑í‡∂∫ ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∂ö‡∂ª‡∂ú‡∂±‡∑ä‡∂±.
2.  **‡∑Å‡∑è‡∂ö ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç‡∂∫ ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∂±‡∑ä‡∂±**: ‡∑Å‡∑è‡∂ö‡∂∫ ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. ‡∂Ö‡∑Ä‡∑í‡∂±‡∑í‡∑Å‡∑ä‡∂†‡∑í‡∂≠ ‡∂±‡∂∏‡∑ä, "‡∑Ñ‡∂≥‡∑î‡∂±‡∑è ‡∂±‡∑ú‡∂ú‡∂≠‡∑ä ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç‡∂∫" ‡∂Ω‡∑ô‡∑É ‡∑É‡∂≥‡∑Ñ‡∂±‡∑ä ‡∂ö‡∂ª ‡∂ë‡∑Ñ‡∑í ‡∂Ω‡∂ö‡∑ä‡∑Ç‡∂´ ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.
3.  **‡∑Å‡∑è‡∂ö ‡∑É‡∑û‡∂õ‡∑ä‚Äç‡∂∫‡∂∫ ‡∂≠‡∂ö‡∑ä‡∑É‡∑ö‡∂ª‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±**: ‡∂ª‡∑ù‡∂ú, ‡∂¥‡∑Ö‡∑í‡∂∂‡∑ù‡∂∞‡∂ö‡∂∫‡∂±‡∑ä ‡∑Ñ‡∑ù ‡∂¥‡∑ì‡∂©‡∂±‡∂ö‡∑è‡∂ª‡∑ì ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫‡∂±‡∑ä‡∂ú‡∑ö ‡∂Ω‡∂ö‡∑ä‡∑Ç‡∂´ ‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂± (‡∑Ä‡∂ª‡∑ä‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä‡∑Ä‡∑ì‡∂∏, ‡∂Ω‡∂¥, ‡∑É‡∑í‡∂Ø‡∑î‡∂ª‡∑î, ‡∂ö‡∑ú‡∑Ö ‡∑Ñ‡∑ê‡∂ö‡∑í‡∂Ω‡∑ì‡∂∏, ‡∂∏‡∑ê‡∂Ω‡∑Ä‡∑ì‡∂∏, ‡∂ö‡∑ò‡∂∏‡∑ì‡∂±‡∑ä, ‡∂Ø‡∑ê‡∂Ω‡∑ä).
4.  **‡∂∏‡∑ñ‡∂Ω‡∑í‡∂ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂†‡∑è‡∂ª‡∂∫ ‡∑É‡∂ö‡∑É‡∂±‡∑ä‡∂±**: ‡∂î‡∂∂‡∂ú‡∑ö ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∑É‡∑Ñ ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è‡∂ú‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±‡∂∫ ‡∂∏‡∂≠ ‡∂¥‡∂Ø‡∂±‡∂∏‡∑ä‡∑Ä, ‡∑É‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä‡∂ö‡∑ä ‡∑É‡∂¥‡∂∫‡∂±‡∑ä‡∂±.
    *   **‡∑É‡∑ò‡∂¢‡∑î ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª**: ‡∂¥‡∑Ö‡∂∏‡∑î‡∑Ä, ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è‡∂ú‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±‡∂∫‡∂ß ‡∂ö‡∑ô‡∂Ω‡∑í‡∂±‡∑ä‡∂∏ ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±.
    *   **‡∑É‡∂∏‡∑É‡∑ä‡∂≠ ‡∑É‡∑û‡∂õ‡∑ä‚Äç‡∂∫ ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫**: (‡∂ã‡∂Ø‡∑è: ‡∑É‡∑û‡∂õ‡∑ä‚Äç‡∂∫ ‡∑É‡∂∏‡∑ä‡∂¥‡∂±‡∑ä‡∂±, ‡∂¥‡∑ì‡∂©‡∂±‡∂∫‡∂ß ‡∂Ω‡∂ö‡∑ä‡∑Ä‡∑ñ, ‡∂ª‡∑ù‡∂ú‡∑ì).
    *   **‡∂±‡∑í‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∂´‡∂∫ ‡∂ö‡∑Ö ‡∂ª‡∑ù‡∂ú ‡∂Ω‡∂ö‡∑ä‡∑Ç‡∂´**: ‡∂î‡∂∂ ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∂≠‡∑ä ‡∂±‡∑í‡∑Å‡∑ä‡∂†‡∑í‡∂≠ ‡∑É‡∂Ω‡∂ö‡∑î‡∂´‡∑î ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.
    *   **‡∑Ä‡∑í‡∂∫ ‡∑Ñ‡∑ê‡∂ö‡∑í ‡∑Ñ‡∑ö‡∂≠‡∑î**: (‡∂ã‡∂Ø‡∑è: ‡∂Ø‡∑í‡∂Ω‡∑ì‡∂ª ‡∂Ü‡∑É‡∑è‡∂Ø‡∂±‡∂∫, ‡∂¢‡∂Ω‡∂∫ ‡∑Ä‡∑ê‡∂©‡∑í‡∑Ä‡∑ì‡∂∏, ‡∂¥‡∑ù‡∑Ç‡∂ö ‡∂å‡∂±‡∂≠‡∑è‡∑Ä‡∂∫).
    *   **‡∑É‡∂≠‡∑ä‡∂ö‡∑è‡∂ª ‡∑É‡∑Ñ ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂ö‡∑è‡∂ª ‡∂∫‡∑ù‡∂¢‡∂±‡∑è**: ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í, ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∑Ö ‡∑Ñ‡∑ê‡∂ö‡∑í ‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª ‡∑É‡∂¥‡∂∫‡∂±‡∑ä‡∂±.

‡∂¥‡∑É‡∑î‡∑Ä ‡∂Ö‡∑É‡∂± ‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂± ‡∑É‡∂≥‡∑Ñ‡∑è, ‡∂∏‡∑î‡∂Ω‡∑ä ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∑ö ‡∑É‡∑Ñ ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø‡∂∫‡∑ö ‡∑É‡∂±‡∑ä‡∂Ø‡∂ª‡∑ä‡∂∑‡∂∫ ‡∂¥‡∑Ä‡∂≠‡∑ä‡∑Ä‡∑è ‡∂ú‡∂±‡∑ä‡∂±. ‡∑É‡∂Ç‡∂ö‡∑ä‡∑Ç‡∑í‡∂¥‡∑ä‡∂≠, ‡∂¥‡∑ä‚Äç‡∂ª‡∂∫‡∑ù‡∂¢‡∂±‡∑Ä‡∂≠‡∑ä ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∑É‡∂¥‡∂∫‡∂±‡∑ä‡∂±.
"""

# --- ‡∂Ü‡∂ö‡∑ò‡∂≠‡∑í ‡∑É‡∑ê‡∂ö‡∑É‡∑î‡∂∏ ---
model = genai.GenerativeModel(
    model_name="gemini-1.5-pro-latest",
    system_instruction=SYSTEM_INSTRUCTION
)

# --- ‡∑É‡∑ê‡∑É‡∑í ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫ (Session State) ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ---
if "chat_session" not in st.session_state:
    st.session_state.chat_session = None
if "messages" not in st.session_state:
    st.session_state.messages = []
if "image" not in st.session_state:
    st.session_state.image = None
if "uploader_key" not in st.session_state:
    st.session_state.uploader_key = 0

# --- UI ‡∑É‡∑Ñ ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í ---
st.title("üå± ‡∑Å‡∑è‡∂ö ‡∑É‡∑û‡∂õ‡∑ä‚Äç‡∂∫ ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂ö‡∂∫")
st.write("‡∂î‡∂∂‡∑ö ‡∑Å‡∑è‡∂ö‡∂∫‡∑ö ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂¥‡∑ê‡∂≠‡∑í ‡∂≠‡∑ì‡∂ª‡∑î‡∑Ä‡∑ô‡∂±‡∑ä ‡∂ã‡∂©‡∑î‡∂ú‡∂≠ ‡∂ö‡∂ª, ‡∂¥‡∑Ñ‡∂≠ ‡∂†‡∑ê‡∂ß‡∑ä ‡∂ö‡∑ú‡∂ß‡∑î‡∑Ä‡∑ô‡∂±‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂± ‡∂Ö‡∑É‡∂±‡∑ä‡∂±.")

# --- ‡∂ú‡∑ú‡∂±‡∑î ‡∂ã‡∂©‡∑î‡∂ú‡∂≠ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∑É‡∑Ñ ‡∂¥‡∑è‡∂Ω‡∂±‡∂∫ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂¥‡∑ê‡∂≠‡∑í ‡∂≠‡∑ì‡∂ª‡∑î‡∑Ä ---
with st.sidebar:
    st.header("‡∂î‡∂∂‡∑ö ‡∑Å‡∑è‡∂ö‡∂∫")
    uploaded_file = st.file_uploader(
        "‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂ã‡∂©‡∑î‡∂ú‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±", 
        type=["jpg", "jpeg", "png"], 
        key=st.session_state.uploader_key
    )
    
    if uploaded_file:
        st.session_state.image = Image.open(uploaded_file)
        st.image(st.session_state.image, caption="‡∂î‡∂∂‡∑ö ‡∑Å‡∑è‡∂ö‡∂∫")

    if st.button("‡∂±‡∑Ä ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø‡∂∫‡∂ö‡∑ä"):
        st.session_state.chat_session = None
        st.session_state.messages = []
        st.session_state.image = None
        st.session_state.uploader_key += 1
        st.rerun()

# --- ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø ‡∂â‡∂≠‡∑í‡∑Ñ‡∑è‡∑É‡∂∫ ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏ ---
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# --- ‡∂†‡∑ê‡∂ß‡∑ä ‡∂Ü‡∂Ø‡∑è‡∂± ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í‡∂∫ ---
if prompt := st.chat_input("‡∂î‡∂∂‡∑ö ‡∑Å‡∑è‡∂ö‡∂∫ ‡∂ú‡∑ê‡∂± ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±‡∂∫‡∂ö‡∑ä ‡∂Ö‡∑É‡∂±‡∑ä‡∂±..."):
    if st.session_state.image is None:
        st.warning("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂¥‡∑Ö‡∂∏‡∑î‡∑Ä ‡∂¥‡∑ê‡∂≠‡∑í ‡∂≠‡∑ì‡∂ª‡∑î‡∑Ä‡∑ö ‡∑Å‡∑è‡∂ö‡∂∫‡∑ö ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂ã‡∂©‡∑î‡∂ú‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.")
        st.stop()

    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    with st.spinner("‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì..."):
        try:
            if st.session_state.chat_session is None:
                st.session_state.chat_session = model.start_chat()
                response = st.session_state.chat_session.send_message(
                    [prompt, st.session_state.image],
                    stream=True
                )
            else:
                response = st.session_state.chat_session.send_message(
                    prompt,
                    stream=True
                )
            
            with st.chat_message("assistant"):
                full_response = ""
                placeholder = st.empty()
                for chunk in response:
                    full_response += chunk.text
                    placeholder.markdown(full_response + "‚ñå")
                placeholder.markdown(full_response)
            
            st.session_state.messages.append({"role": "assistant", "content": full_response})

        except Exception as e:
            st.error(f"‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑í‡∑Ä‡∑í‡∂∫: {e}")

st.divider()
st.caption("‡∑Ä‡∑í‡∂∫‡∑è‡∂†‡∂±‡∂∫: ‡∂∏‡∑ô‡∂∏ AI ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∂Ø‡∑ê‡∂±‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∑ö ‡∂Ö‡∂ª‡∂∏‡∑î‡∂´‡∑î ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∑Ä‡∂± ‡∂Ö‡∂≠‡∂ª, ‡∂ë‡∂∫ ‡∑Ä‡∑ò‡∂≠‡∑ä‡∂≠‡∑ì‡∂∫ ‡∂ã‡∂Ø‡∑ä‡∂∑‡∑í‡∂Ø ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑Ñ‡∑ù ‡∂ö‡∑ò‡∑Ç‡∑í‡∂ö‡∑è‡∂ª‡∑ä‡∂∏‡∑í‡∂ö ‡∂ã‡∂¥‡∂Ø‡∑ô‡∑É‡∑ä ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ü‡∂Ø‡∑ö‡∑Å‡∂ö‡∂∫‡∂ö‡∑ä ‡∂±‡∑ú‡∑Ä‡∑ö.")