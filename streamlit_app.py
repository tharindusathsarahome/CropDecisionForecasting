import streamlit as st
from google import generativeai as genai
from PIL import Image
import io
import time

# --- Streamlit ‡∂¥‡∑í‡∂ß‡∑î ‡∑É‡∑ê‡∂ö‡∑É‡∑î‡∂∏ ---
st.set_page_config(
    page_title="Plant Disease Analyzer",
    page_icon="üå±",
    layout="centered"
)

# --- API ‡∂∫‡∂≠‡∑î‡∂ª ‡∑É‡∑ê‡∂ö‡∑É‡∑ì‡∂∏ ---
try:
    api_key = st.secrets['GEMINI_API_KEY']
    genai.configure(api_key=api_key)
except (KeyError, Exception) as e:
    st.error(f"GEMINI_API_KEY ‡∑É‡∑ú‡∂∫‡∑è‡∂ú‡∂≠ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂ë‡∂∫ ‡∂î‡∂∂‡∂ú‡∑ö Streamlit ‡∂ª‡∑Ñ‡∑É‡∑ä ‡∑Ä‡∑ô‡∂≠ ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.")
    st.stop()

# --- AI ‡∂Ü‡∂ö‡∑ò‡∂≠‡∑í‡∂∫ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑É‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í ‡∂ã‡∂¥‡∂Ø‡∑ô‡∑É‡∑ä ---
SYSTEM_INSTRUCTION = """
‡∂î‡∂∂ ‡∑Å‡∑è‡∂ö ‡∂ª‡∑ù‡∂ú ‡∂¥‡∑í‡∑Ö‡∑í‡∂∂‡∂≥ ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç‡∂•, ‡∂∏‡∑í‡∂≠‡∑ä‚Äç‡∂ª‡∑Å‡∑ì‡∂Ω‡∑ì ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∑É‡∑Ñ‡∑è‡∂∫‡∂ö‡∂∫‡∑ô‡∂ö‡∑í. ‡∂î‡∂∂‡∂ú‡∑ö ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫ ‡∑Ä‡∂±‡∑ä‡∂±‡∑ö ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è ‡∑É‡∂∏‡∂ü ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø‡∂∫‡∂ö‡∑ä ‡∑Ñ‡∂ª‡∑Ñ‡∑è ‡∂î‡∑Ä‡∑î‡∂±‡∑ä‡∂ú‡∑ö ‡∑Å‡∑è‡∂ö‡∂∫‡∑ö ‡∂ú‡∑ê‡∂ß‡∂Ω‡∑î‡∑Ä ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∑ô‡∂± ‡∑Ä‡∑í‡∑É‡∂≥‡∑î‡∂∏‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ì‡∂∏‡∂∫‡∑í. ‡∂∏‡∑ô‡∂∏ ‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª‡∂∫‡∂±‡∑ä ‡∂Ö‡∂±‡∑î‡∂ú‡∂∏‡∂±‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±:

**‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª 1: ‡∂∏‡∑ñ‡∂Ω‡∑í‡∂ö ‡∑Ñ‡∑ê‡∂≥‡∑í‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏ ‡∑É‡∑Ñ ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±‡∂∫**
- ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∑É‡∑Ñ ‡∂¥‡∑Ö‡∂∏‡∑î ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±‡∂∫ ("‡∂∏‡∑ö‡∂ö‡∂ß ‡∂∏‡∑ú‡∂ö‡∂Ø ‡∑Ä‡∑ô‡∂Ω‡∑è ‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑ä‡∂±‡∑ô?") ‡∂ë‡∑Ä‡∑î ‡∑Ä‡∑í‡∂ß, ‡∂¥‡∑Ö‡∂∏‡∑î‡∑Ä ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫ ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∂ö‡∂ª ‡∑Å‡∑è‡∂ö‡∂∫ ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è ‡∂ú‡∂±‡∑ä‡∂±.
- ‡∂â‡∂±‡∑ä‡∂¥‡∑É‡∑î, ‡∂∏‡∑ô‡∑Ä‡∑ê‡∂±‡∑í ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂†‡∑è‡∂ª‡∂∫‡∂ö‡∑ä ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∂±‡∑ä‡∂±: "‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä! ‡∂î‡∂∂ ‡∂Ω‡∂∂‡∑è‡∂Ø‡∑î‡∂±‡∑ä ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∑ö ‡∂¥‡∑ô‡∂±‡∑ô‡∂± ‡∂Ü‡∂ö‡∑è‡∂ª‡∂∫‡∂ß ‡∂∏‡∑ô‡∂∫ [‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∂≠‡∑ä ‡∑Å‡∑è‡∂ö‡∂∫‡∑ö ‡∂±‡∂∏] ‡∑Å‡∑è‡∂ö‡∂∫‡∂ö‡∑ä. ‡∂ë‡∂∫ ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂Ø?"
- ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∂≠ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö‡∑í ‡∂±‡∂∏‡∑ä, "‡∂∏‡∑ô‡∂∏ ‡∑Å‡∑è‡∂ö‡∂∫ ‡∂ö‡∑î‡∂∏‡∂ö‡∑ä‡∂Ø‡∑ê‡∂∫‡∑í ‡∂∏‡∂ß ‡∂¥‡∑ê‡∑Ä‡∑É‡∑í‡∂∫ ‡∑Ñ‡∑ê‡∂ö‡∑í‡∂Ø?" ‡≤é‡≤Ç‡≤¶‡≥Å ‡∂Ö‡∑É‡∂±‡∑ä‡∂±.

**‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª 2: ‡∂∏‡∑ñ‡∂Ω‡∑í‡∂ö ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∑É‡∑Ñ ‡∂¥‡∑è‡∂ª‡∑í‡∑É‡∂ª‡∑í‡∂ö ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±**
- ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è ‡∑Å‡∑è‡∂ö‡∂∫ ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∑Ö ‡∂¥‡∑É‡∑î ("‡∂î‡∑Ä‡∑ä"), ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∑ö ‡∂¥‡∑ô‡∂±‡∑ô‡∂± ‡∂ª‡∑ù‡∂ú ‡∂Ω‡∂ö‡∑ä‡∑Ç‡∂´ ‡∂ú‡∑ê‡∂± ‡∂ö‡∑ô‡∂ß‡∑í ‡∑É‡∂ß‡∑Ñ‡∂±‡∂ö‡∑ä ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±. (‡∂ã‡∂Ø‡∑è: "‡∑Ñ‡∑ú‡∂≥‡∂∫‡∑í. ‡∂∏‡∂∏ ‡∂Ø‡∂ö‡∑í‡∂± ‡∑Ä‡∑í‡∂Ø‡∑í‡∑Ñ‡∂ß, ‡∂ö‡∑ú‡∑Ö‡∑Ä‡∂Ω ‡∑É‡∑î‡∂Ø‡∑î ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂≠‡∑í ‡∂Ω‡∂¥ ‡∑É‡∑Ñ ‡∂∫‡∂ß‡∑í ‡∂¥‡∑ê‡∂≠‡∑ä‡∂≠‡∑ö ‡∂¥‡∑î‡∑É‡∑ä ‡∑Ä‡∑ê‡∂±‡∑í ‡∑É‡∑ä‡∑Ä‡∂∑‡∑è‡∑Ä‡∂∫‡∂ö‡∑ä ‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑Ä‡∑è.")
- ‡∂â‡∂±‡∑ä‡∂¥‡∑É‡∑î, ‡∂ú‡∑ê‡∂ß‡∂Ω‡∑î‡∑Ä ‡∂≠‡∑Ä‡∂Ø‡∑î‡∂ª‡∂ß‡∂≠‡∑ä ‡∂≠‡∑ö‡∂ª‡∑î‡∂∏‡∑ä ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∂∏‡∑ô‡∑Ä‡∑ê‡∂±‡∑í ‡∑Ä‡∑í‡∑Ä‡∑ò‡∂≠ ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±‡∂∫‡∂ö‡∑ä ‡∂Ö‡∑É‡∂±‡∑ä‡∂±: "‡∂ª‡∑ù‡∂ú‡∂∫ ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∑Ä ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß, ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂∏‡∂ß ‡∂≠‡∑Ä ‡∂ß‡∑í‡∂ö‡∂ö‡∑ä ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂ö‡∑í‡∂∫‡∂±‡∑ä‡∂±. ‡∂∏‡∑ö ‡∂Ø‡∑í‡∂±‡∑Ä‡∂Ω ‡∂ö‡∑è‡∂Ω‡∂ú‡∑î‡∂´‡∂∫ ‡∂ö‡∑ú‡∑Ñ‡∑ú‡∂∏‡∂Ø? ‡∂Ö‡∂∞‡∑í‡∂ö ‡∑Ä‡∂ª‡∑ä‡∑Ç‡∑è‡∑Ä‡∂ö‡∑ä ‡∑Ñ‡∑ù ‡∂¥‡∑í‡∂±‡∑ä‡∂±‡∂ö‡∑ä ‡∂≠‡∑í‡∂∂‡∑ô‡∂±‡∑Ä‡∑è‡∂Ø? ‡∑Å‡∑è‡∂ö‡∂∫‡∂ß ‡∑Ñ‡∑ú‡∂≥‡∑í‡∂±‡∑ä ‡∑Ñ‡∑í‡∂ª‡∑î ‡∂ë‡∑Ö‡∑í‡∂∫ ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂±‡∑Ä‡∑è‡∂Ø?"

**‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª 3: ‡∑É‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∑É‡∑Ñ ‡∑Ä‡∑í‡∑É‡∂≥‡∑î‡∂∏‡∑ä**
- ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è ‡∂¥‡∑è‡∂ª‡∑í‡∑É‡∂ª‡∑í‡∂ö ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑î‡∂±‡∑ä ‡∂¥‡∑É‡∑î, ‡∂ë‡∂∏ ‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î (‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫, ‡∂ª‡∑ù‡∂ú ‡∂Ω‡∂ö‡∑ä‡∑Ç‡∂´, ‡∂ö‡∑è‡∂Ω‡∂ú‡∑î‡∂´‡∂∫) ‡∂ë‡∂ö‡∂ß ‡∂ú‡∂Ω‡∂¥‡∑è, ‡∑É‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä‡∂ö‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±.
- ‡∂∏‡∑ô‡∂∏ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä‡∑ö ‡∂¥‡∑Ñ‡∂≠ ‡∂Ø‡∑ë ‡∂Ö‡∂±‡∑í‡∑Ä‡∑è‡∂ª‡∑ä‡∂∫‡∂∫‡∑ô‡∂±‡∑ä‡∂∏ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫:
    1.  **‡∂±‡∑í‡∑Å‡∑ä‡∂†‡∑í‡∂≠ ‡∂ª‡∑ù‡∂ú ‡∑Ä‡∑í‡∂±‡∑í‡∑Å‡∑ä‡∂†‡∂∫:** (‡∂ã‡∂Ø‡∑è: ‡∂∫‡∂ß‡∑í ‡∂¥‡∑î‡∑É‡∑ä ‡∂ª‡∑ù‡∂ú‡∂∫ - Downy Mildew).
    2.  **‡∑Ñ‡∑ö‡∂≠‡∑î:** ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è‡∂ú‡∑ö ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∑É‡∂∏‡∂ü ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞ ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä ‡∑Ñ‡∑ö‡∂≠‡∑î ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.
    3.  **‡∑Ä‡∑í‡∑É‡∂≥‡∑î‡∂∏‡∑ä ‡∑É‡∑Ñ ‡∂¥‡∑è‡∂Ω‡∂±‡∂∫:** ‡∂ö‡∑ä‡∑Ç‡∂´‡∑í‡∂ö ‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª, ‡∂ö‡∑è‡∂∂‡∂±‡∑í‡∂ö ‡∑É‡∑Ñ ‡∂ª‡∑É‡∑è‡∂∫‡∂±‡∑í‡∂ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂ö‡∑è‡∂ª, ‡∑É‡∑Ñ ‡∑Ä‡∑ê‡∑Ö‡∑ê‡∂ö‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ö ‡∂ö‡∑ä‚Äç‡∂ª‡∂∏ ‡∂Ω‡∑ô‡∑É ‡∂ö‡∑ú‡∂ß‡∑É‡∑ä ‡∂ö‡∂ª ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í‡∑Ä ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂¥‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.

**‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª 4: ‡∂¥‡∑É‡∑î ‡∑Ä‡∑í‡∂¥‡∂ª‡∂∏**
- ‡∂î‡∂∂‡∂ú‡∑ö ‡∑É‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑ô‡∂±‡∑ä ‡∂¥‡∑É‡∑î‡∑Ä, "‡∂∏‡∑ö ‡∂ú‡∑ê‡∂± ‡∂î‡∂∂‡∂ß ‡∂≠‡∑Ä‡∂≠‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂± ‡∂≠‡∑í‡∂∂‡∑ö‡∂Ø?" ‡≤é‡≤Ç‡≤¶‡≥Å ‡∂Ö‡∑É‡∂∏‡∑í‡∂±‡∑ä ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø‡∂∫ ‡∑Ä‡∑í‡∑Ä‡∑ò‡∂≠‡∑Ä ‡∂≠‡∂∂‡∂±‡∑ä‡∂±. ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è‡∂ú‡∑ö ‡∂ï‡∂±‡∑ë‡∂∏ ‡∂Ö‡∂∏‡∂≠‡∂ª ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±‡∂∫‡∂ö‡∂ß ‡∂ö‡∑ô‡∂ß‡∑í ‡∑É‡∑Ñ ‡∂¥‡∑ä‚Äç‡∂ª‡∂∫‡∑ù‡∂¢‡∂±‡∑Ä‡∂≠‡∑ä ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±.

‡∑É‡∑ë‡∂∏ ‡∑Ä‡∑í‡∂ß‡∂∏ ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.
"""

# --- ‡∂Ü‡∂ö‡∑ò‡∂≠‡∑í ‡∑É‡∑ê‡∂ö‡∑É‡∑î‡∂∏ ---
model = genai.GenerativeModel(
    model_name="gemini-1.5-pro-latest",
    system_instruction=SYSTEM_INSTRUCTION
)

# --- ‡∑É‡∑ê‡∑É‡∑í ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫ (Session State) ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ---
if "chat_session" not in st.session_state:
    st.session_state.chat_session = None
if "messages" not in st.session_state:
    st.session_state.messages = []
if "uploader_key" not in st.session_state:
    st.session_state.uploader_key = 0

# --- ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∑ì‡∂≠‡∑ä‡∑Ä‡∂∫‡∂±‡∑ä ---
def reset_session():
    """‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∑É‡∑ê‡∑É‡∑í‡∂∫ ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∑É‡∂ö‡∑É‡∂∫‡∑í"""
    st.session_state.clear()
    st.rerun()

# --- UI ‡∑É‡∑Ñ ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í ---
st.title("üå± Plant Disease Analyzer")
st.write("‡∂î‡∂∂‡∑ö ‡∑Å‡∑è‡∂ö‡∂∫‡∑ö ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂¥‡∑ê‡∂≠‡∑í ‡∂≠‡∑ì‡∂ª‡∑î‡∑Ä‡∑ô‡∂±‡∑ä ‡∂ã‡∂©‡∑î‡∂ú‡∂≠ ‡∂ö‡∂ª, ‡∂¥‡∑Ñ‡∂≠ ‡∂†‡∑ê‡∂ß‡∑ä ‡∂ö‡∑ú‡∂ß‡∑î‡∑Ä‡∑ô‡∂±‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂± ‡∂Ö‡∑É‡∂±‡∑ä‡∂±.")

with st.sidebar:
    st.header("‡∂î‡∂∂‡∑ö ‡∑Å‡∑è‡∂ö‡∂∫")
    uploaded_file = st.file_uploader(
        "‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂ã‡∂©‡∑î‡∂ú‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±",
        type=["jpg", "jpeg", "png"],
        key=f"uploader_{st.session_state.get('uploader_key', 0)}"
    )
    if uploaded_file:
        st.image(uploaded_file, caption="‡∂î‡∂∂‡∑ö ‡∑Å‡∑è‡∂ö‡∂∫")
    if st.button("‡∂±‡∑Ä ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø‡∂∫‡∂ö‡∑ä"):
        reset_session()

# --- ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø ‡∂â‡∂≠‡∑í‡∑Ñ‡∑è‡∑É‡∂∫ ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏ ---
for message in st.session_state.get("messages", []):
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# --- ‡∂†‡∑ê‡∂ß‡∑ä ‡∂Ü‡∂Ø‡∑è‡∂± ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í‡∂∫ ---
if prompt := st.chat_input("‡∂î‡∂∂‡∑ö ‡∑Å‡∑è‡∂ö‡∂∫ ‡∂ú‡∑ê‡∂± ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±‡∂∫‡∂ö‡∑ä ‡∂Ö‡∑É‡∂±‡∑ä‡∂±..."):
    # ‡∂¥‡∑Ö‡∂∏‡∑î ‡∑Ä‡∂≠‡∑è‡∑Ä‡∂ß ‡∂±‡∂∏‡∑ä, ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂Ö‡∂±‡∑í‡∑Ä‡∑è‡∂ª‡∑ä‡∂∫‡∂∫‡∑í
    if not st.session_state.get("chat_session") and not uploaded_file:
        st.warning("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂¥‡∑Ö‡∂∏‡∑î‡∑Ä ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂ã‡∂©‡∑î‡∂ú‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.")
        st.stop()

    # ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è‡∂ú‡∑ö ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    with st.spinner("‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∑É‡∂ö‡∑É‡∂∏‡∑í‡∂±‡∑ä..."):
        try:
            # ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø‡∂∫ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∑Ñ‡∑ù ‡∂¥‡∑Ä‡∂≠‡∑ä‡∑Ä‡∑è‡∂ú‡∑ô‡∂± ‡∂∫‡∑è‡∂∏
            if st.session_state.chat_session is None:
                st.session_state.chat_session = model.start_chat(history=[])
                # ‡∂¥‡∑Ö‡∂∏‡∑î ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∑É‡∂∏‡∂ü ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫ ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏
                image_obj = Image.open(uploaded_file)
                response = st.session_state.chat_session.send_message([prompt, image_obj], stream=True)
            else:
                # ‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑í‡∂± ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø‡∂∫‡∂ö‡∂ß ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏
                response = st.session_state.chat_session.send_message(prompt, stream=True)

            # AI ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂†‡∑è‡∂ª‡∂∫ streaming ‡∂Ü‡∂ö‡∑è‡∂ª‡∂∫‡∂ß ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏
            with st.chat_message("assistant"):
                full_response = ""
                placeholder = st.empty()
                for chunk in response:
                    full_response += chunk.text
                    placeholder.markdown(full_response + "‚ñå")
                placeholder.markdown(full_response)
            
            # ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂†‡∑è‡∂ª‡∂∫ ‡∂â‡∂≠‡∑í‡∑Ñ‡∑è‡∑É‡∂∫‡∂ß ‡∂ë‡∂ö‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
            st.session_state.messages.append({"role": "assistant", "content": full_response})

        except Exception as e:
            st.error(f"‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø‡∂∫‡∑ö‡∂Ø‡∑ì ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑í‡∑Ä‡∑í‡∂∫: {e}")

st.divider()
st.caption("‚ö†Ô∏è ‡∂∏‡∑ô‡∂∏ AI ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∑Ä‡∑ò‡∂≠‡∑ä‡∂≠‡∑ì‡∂∫ ‡∂ö‡∑ò‡∑Ç‡∑í‡∂ö‡∑è‡∂ª‡∑ä‡∂∏‡∑í‡∂ö ‡∂ã‡∂¥‡∂Ø‡∑ô‡∑É‡∑ä ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ü‡∂Ø‡∑ö‡∑Å‡∂ö‡∂∫‡∂ö‡∑ä ‡∑Ä‡∑ö.")